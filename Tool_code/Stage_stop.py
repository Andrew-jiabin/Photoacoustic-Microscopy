import serial
import time

def force_stop_and_reset(port="COM4"):
    """
    [ç‹¬ç«‹æ€¥åœå‡½æ•°]
    åŠŸèƒ½ï¼šå¼ºè¡Œæ‰“æ–­å½“å‰ä»»åŠ¡ï¼Œå¹¶æ³¨å…¥ä¸€ä¸ªâ€œ0æ­¥ç©ºæ‰«æâ€æ¥é‡ç½®æ§åˆ¶å™¨çŠ¶æ€ã€‚
    æ— è®ºä¹‹å‰çš„ç¨‹åºæ˜¯å¦åœ¨è¿è¡Œï¼Œè¿™ä¸ªå‡½æ•°éƒ½ä¼šå°è¯•å¼ºå ä¸²å£è¿›è¡Œå¤ä½ã€‚
    """
    print(f"ğŸ›‘ [ç³»ç»Ÿ] æ­£åœ¨å°è¯•è¿æ¥ {port} è¿›è¡Œå¼ºåˆ¶å¤ä½...")
    
    ser = None
    try:
        # 1. å¼ºè¡Œæ‰“å¼€ä¸²å£ (115200æ³¢ç‰¹ç‡)
        # timeoutè®¾ä¸º0.5ç§’ï¼Œé˜²æ­¢å¡æ­»
        ser = serial.Serial(port, 115200, timeout=0.5)
        ser.flushInput()
        
        # --- å…³é”®åˆå§‹åŒ– 1: ç¡®ä¿è¿›å…¥æ ‡å‡†æ¨¡å¼ ---
        # åªæœ‰åœ¨ COMP,0 ä¸‹ï¼ŒI æŒ‡ä»¤å’Œé˜Ÿåˆ—æ¸…ç†æ‰æœ€æœ‰æ•ˆ
        ser.write(b"COMP,0\r")
        time.sleep(0.1)
        
        # --- å…³é”®æ­¥éª¤ 2: å…ˆæ‰“æ–­ (Interrupt) ---
        # åœ¨å‘é€æ–°å‚æ•°å‰ï¼Œå¿…é¡»å…ˆå‘ Iï¼ŒæŠŠæ­£åœ¨è·‘çš„æ—§ä»»åŠ¡åœä¸‹ï¼Œå¹¶æ¸…ç©ºæŒ‡ä»¤é˜Ÿåˆ—
        # å¦åˆ™æ§åˆ¶å™¨ä¼šæ‹’ç» N å’Œ X æŒ‡ä»¤ï¼ŒæŠ¥ "E,18" (Queue Full)
        print("   1. å‘é€ä¸­æ–­ä¿¡å· (I)...")
        ser.write(b"I\r") 
        time.sleep(0.2) # ç»™ç¡¬ä»¶ä¸€ç‚¹åˆ¹è½¦æ—¶é—´
        ser.flushInput() # æ¸…æ‰å¯èƒ½æ¶Œå›æ¥çš„é”™è¯¯ä¿¡æ¯
        
        # --- å…³é”®æ­¥éª¤ 3: æ³¨å…¥ç©ºæ‰«æå‚æ•° ---
        # è¿™ä¸€æ­¥å¦‚æœä½ è§‰å¾—â€œæ²¡ååº”â€ï¼Œé€šå¸¸æ˜¯å› ä¸ºä¹‹å‰æ²¡å‘ Iï¼Œæˆ–è€…æ²¡åˆ‡ COMP,0
        print("   2. æ³¨å…¥ç©ºä»»åŠ¡ (N,0,0)...")
        ser.write(b"N,0,0\r")  # 1x1 åƒç´ 
        ser.write(b"X,0,0\r")  # 0 æ­¥é•¿
        ser.write(b"AS,1,0,1,H,S\r") # é‡æ–°é…ç½® AS å‚æ•°ï¼Œè¦†ç›–æ—§è®¾ç½®
        time.sleep(0.1)
        
        # --- å…³é”®æ­¥éª¤ 4: å¯åŠ¨ç©ºä»»åŠ¡ä»¥å¤ä½çŠ¶æ€æœº ---
        print("   3. è§¦å‘å¤ä½ (AS,1)...")
        ser.write(b"AS,1\r")
        time.sleep(0.2) # ç­‰å®ƒç¬é—´è·‘å®Œ
        
        # --- éªŒè¯çŠ¶æ€ ---
        ser.flushInput()
        ser.write(b"AS\r")
        status = ser.read_until(b'\r').decode().strip()
        
        if status == "0":
            print("âœ… [æˆåŠŸ] æ§åˆ¶å™¨å·²å¤ä½ (Idle)ã€‚")
        else:
            print(f"âš ï¸ [è­¦å‘Š] è½¯å¤ä½æœªç¡®è®¤ (çŠ¶æ€: {status})ï¼Œå°è¯•æš´åŠ›åˆ‡æ–­...")
            ser.write(b"K\r") # æœ€åçš„æ‰‹æ®µ
            
    except Exception as e:
        print(f"âŒ æ— æ³•æ“ä½œä¸²å£: {e}")
        print("   (æç¤º: è¯·å…ˆå…³é—­æ­£åœ¨è¿è¡Œæ‰«æçš„ Python çª—å£ï¼Œé‡Šæ”¾ä¸²å£å ç”¨)")
        
    finally:
        if ser and ser.is_open:
            ser.close()

# --- ç›´æ¥è¿è¡Œæµ‹è¯• ---
if __name__ == "__main__":
    force_stop_and_reset("COM4")